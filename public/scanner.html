<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>GŒõRO | Scanner</title>
    <link rel="stylesheet" href="/styles.css">
    <meta name="theme-color" content="#08080f">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <style>
        .page {
            padding: var(--space-lg);
            min-height: 100vh;
        }

        .header {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .back-btn {
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: var(--space-sm) var(--space-md);
            color: var(--text-muted);
            cursor: pointer;
        }

        .page-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        /* Scanner */
        .scanner-container {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            overflow: hidden;
            margin-bottom: var(--space-xl);
        }

        #reader {
            width: 100%;
        }

        #reader video {
            border-radius: var(--radius-lg);
        }

        /* Result Card */
        .result-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            text-align: center;
            margin-bottom: var(--space-xl);
        }

        .result-icon {
            font-size: 4rem;
            margin-bottom: var(--space-md);
        }

        .result-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: var(--space-sm);
        }

        .result-card.success {
            border-color: var(--success);
        }

        .result-card.success .result-title {
            color: var(--success);
        }

        .result-card.error {
            border-color: var(--error);
        }

        .result-card.error .result-title {
            color: var(--error);
        }

        .result-wallet {
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--text-muted);
            background: var(--bg-glass);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            display: inline-block;
            margin-top: var(--space-md);
        }

        .scan-btn {
            width: 100%;
            padding: var(--space-lg);
            background: var(--accent-gradient);
            border: none;
            border-radius: var(--radius-lg);
            color: white;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
        }

        /* History */
        .history-title {
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: var(--space-md);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: var(--space-md);
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            font-size: 0.8rem;
        }

        .history-item.valid {
            border-left: 3px solid var(--success);
        }

        .history-item.invalid {
            border-left: 3px solid var(--error);
        }
    </style>
</head>

<body class="safe-area-top safe-area-bottom">
    <div class="container page">
        <div class="header">
            <button class="back-btn" onclick="location.href='/dashboard.html'">‚Üê</button>
            <h1 class="page-title">üëÆ Scanner</h1>
        </div>

        <div class="scanner-container">
            <div id="reader"></div>
        </div>

        <div id="result"></div>

        <button class="scan-btn" onclick="startScan()">Start Scanning</button>

        <div style="margin-top: var(--space-xl);">
            <h3 class="history-title">Scan History</h3>
            <div class="history-list" id="history"></div>
        </div>
    </div>

    <script>
        let html5QrcodeScanner = null;

        function startScan() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear();
            }

            html5QrcodeScanner = new Html5Qrcode("reader");

            html5QrcodeScanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess,
                () => { }
            ).catch(err => {
                document.getElementById('result').innerHTML = `
                    <div class="result-card error">
                        <div class="result-icon">üì∑</div>
                        <div class="result-title">Camera Error</div>
                        <p style="color: var(--text-muted);">Please allow camera access</p>
                    </div>
                `;
            });
        }

        async function onScanSuccess(decodedText) {
            html5QrcodeScanner.stop();
            playSound('scan');

            // The QR contains wallet address
            const address = decodedText;

            document.getElementById('result').innerHTML = `
                <div class="result-card">
                    <div class="result-icon">‚è≥</div>
                    <div class="result-title">Verifying...</div>
                </div>
            `;

            try {
                const res = await fetch(`/verify?address=${address}`);
                const data = await res.json();

                if (data.valid && data.count > 0) {
                    playSound('success');
                    showResult('success', 'ACCESS GRANTED', address, data.count);
                    logScan(address, true);
                } else {
                    playSound('error');
                    showResult('error', 'NO MEMORIES', address, 0);
                    logScan(address, false);
                }

                // Log to backend
                fetch('/api/scan-log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wallet_address: address, status: data.valid ? 'GRANTED' : 'DENIED' })
                }).catch(() => { });

            } catch (e) {
                showResult('error', 'SCAN ERROR', address, 0);
            }
        }

        function showResult(type, title, address, count) {
            const icons = { success: '‚úÖ', error: '‚ùå' };
            document.getElementById('result').innerHTML = `
                <div class="result-card ${type}">
                    <div class="result-icon">${icons[type]}</div>
                    <div class="result-title">${title}</div>
                    ${count > 0 ? `<p style="color: var(--accent-secondary);">${count} memories found</p>` : ''}
                    <div class="result-wallet">${address.slice(0, 8)}...${address.slice(-4)}</div>
                </div>
            `;
        }

        function logScan(address, valid) {
            const history = document.getElementById('history');
            const item = document.createElement('div');
            item.className = `history-item ${valid ? 'valid' : 'invalid'}`;
            item.innerHTML = `
                <span>${address.slice(0, 8)}...</span>
                <span>${valid ? '‚úì GRANTED' : '‚úó DENIED'}</span>
            `;
            history.insertBefore(item, history.firstChild);
        }

        function playSound(type) {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);

                if (type === 'success') {
                    osc.frequency.value = 880;
                } else if (type === 'error') {
                    osc.frequency.value = 220;
                } else {
                    osc.frequency.value = 440;
                }

                osc.type = 'sine';
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                osc.start();
                osc.stop(ctx.currentTime + 0.2);
            } catch (e) { }
        }
    </script>
</body>

</html>