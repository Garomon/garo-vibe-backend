<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>GŒõRO | My Collection</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#08080f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="stylesheet" href="/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@web3auth/modal@9.6.0/dist/modal.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@web3auth/solana-provider@9.6.0/dist/solanaProvider.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/buffer/6.0.3/buffer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* Dashboard Specific Styles */
        .hero {
            text-align: center;
            padding: var(--space-xl) 0;
        }

        .avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto var(--space-lg);
            box-shadow: var(--shadow-glow);
            animation: float 4s ease-in-out infinite;
        }

        .level-title {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: var(--space-xs);
        }

        .memory-count {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .memory-count strong {
            color: var(--accent-secondary);
            font-weight: 700;
        }

        /* XP Section */
        .xp-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
        }

        .xp-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .xp-amount {
            font-size: 1.75rem;
            font-weight: 800;
        }

        .xp-amount span {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-left: var(--space-xs);
        }

        .streak-badge {
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            padding: var(--space-xs) var(--space-md);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .xp-progress {
            margin-bottom: var(--space-sm);
        }

        .xp-levels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Memory Gallery */
        .section-title {
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: var(--space-md);
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-sm);
            margin-bottom: var(--space-xl);
        }

        .memory-item {
            aspect-ratio: 1;
            border-radius: var(--radius-lg);
            overflow: hidden;
            position: relative;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            transition: all var(--transition-normal);
        }

        .memory-item:hover {
            transform: scale(1.05);
            border-color: var(--border-glow);
            box-shadow: var(--shadow-glow);
        }

        .memory-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .memory-date {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
            padding: var(--space-lg) var(--space-sm) var(--space-sm);
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
        }

        .empty-state {
            text-align: center;
            padding: var(--space-2xl) var(--space-lg);
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: var(--space-md);
            opacity: 0.3;
        }

        /* Rewards */
        .rewards-list {
            margin-bottom: var(--space-xl);
        }

        .reward-item {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-sm);
            transition: all var(--transition-normal);
        }

        .reward-item.unlocked {
            border-color: rgba(34, 197, 94, 0.3);
            background: rgba(34, 197, 94, 0.05);
        }

        .reward-item.locked {
            opacity: 0.5;
        }

        .reward-icon {
            font-size: 1.5rem;
        }

        .reward-text {
            flex: 1;
            font-size: 0.875rem;
        }

        .reward-status {
            font-size: 0.75rem;
            color: var(--success);
        }

        /* QR Section */
        .qr-section {
            display: none;
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            text-align: center;
            margin-bottom: var(--space-xl);
            position: relative;
        }

        .qr-label {
            color: #000;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            margin-bottom: var(--space-md);
        }

        #qrcode {
            display: flex;
            justify-content: center;
        }

        .qr-hint {
            color: #666;
            font-size: 0.75rem;
            margin-top: var(--space-md);
        }

        /* Navigation Grid */
        .nav-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-sm);
        }

        .nav-btn {
            padding: var(--space-md);
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
            border-color: var(--border-glow);
        }

        .nav-btn.highlight {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* Loading */
        .loading-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            gap: var(--space-lg);
        }

        .loading-text {
            color: var(--text-muted);
            font-size: 0.875rem;
        }
    </style>
</head>

<body class="safe-area-top safe-area-bottom">
    <div class="container" style="padding-top: var(--space-lg); padding-bottom: var(--space-2xl);">
        <div id="content">
            <div class="loading-screen">
                <div class="loader"></div>
                <p class="loading-text">Loading your collection...</p>
            </div>
        </div>
    </div>

    <script>
        // Web3Auth Config
        const CLIENT_ID = "BLVk4nc6lfY2oRnqR7tDjkZn-Kpv8JbgS3lE6iDDWNh5zhIW2WdM3_h6fBu8n92Y0FuHOflV0TwIKc6yPNK0cSI";
        const NETWORK = "sapphire_devnet";
        let web3auth = null;
        let currentUserAddress = '';

        const LEVELS = [
            { min: 0, name: "New Fan", emoji: "‚ú®" },
            { min: 1, name: "Bronze", emoji: "ü•â" },
            { min: 3, name: "Silver", emoji: "ü•à" },
            { min: 5, name: "Gold VIP", emoji: "ü•á" },
            { min: 10, name: "Diamond", emoji: "üíé" },
            { min: 20, name: "Legend", emoji: "üëë" }
        ];

        const BENEFITS = [
            { required: 1, icon: "üéµ", text: "Exclusive content access" },
            { required: 3, icon: "üéüÔ∏è", text: "Early ticket access" },
            { required: 5, icon: "üéß", text: "Downloadable stems" },
            { required: 10, icon: "üìû", text: "1:1 call with GŒõRO" }
        ];

        function getLevel(count) {
            let level = LEVELS[0];
            for (const l of LEVELS) { if (count >= l.min) level = l; }
            return level;
        }

        async function init() {
            try {
                const Web3AuthModal = window.Modal?.Web3Auth || window.Web3Auth;
                const SolanaProvider = window.SolanaProvider?.SolanaPrivateKeyProvider || window.SolanaPrivateKeyProvider;

                const chainConfig = {
                    chainNamespace: "solana",
                    chainId: "0x3",
                    rpcTarget: "https://api.devnet.solana.com",
                    displayName: "Solana Devnet",
                    blockExplorer: "https://explorer.solana.com",
                    ticker: "SOL",
                    tickerName: "Solana",
                };

                const privateKeyProvider = new SolanaProvider({ config: { chainConfig } });

                web3auth = new Web3AuthModal({
                    clientId: CLIENT_ID,
                    web3AuthNetwork: NETWORK,
                    chainConfig,
                    privateKeyProvider,
                    uiConfig: { mode: "dark", uxMode: "redirect" }
                });

                await web3auth.initModal();

                if (web3auth.connected) {
                    const accounts = await web3auth.provider.request({ method: "getAccounts" });
                    await loadDashboard(accounts[0]);
                } else {
                    showLoginPrompt();
                }
            } catch (e) {
                console.error("Init Error:", e);
                showError(e.message);
            }
        }

        function showLoginPrompt() {
            document.getElementById('content').innerHTML = `
                <div class="loading-screen">
                    <div class="empty-icon">üîê</div>
                    <p style="color: var(--text-secondary);">You're not logged in</p>
                    <a href="/onboarding.html" class="btn btn-primary" style="margin-top: var(--space-md);">Enter GŒõRO</a>
                </div>
            `;
        }

        function showError(msg) {
            document.getElementById('content').innerHTML = `
                <div class="loading-screen">
                    <div class="empty-icon" style="color: var(--error);">‚ö†Ô∏è</div>
                    <p style="color: var(--error);">${msg}</p>
                    <a href="/" class="btn btn-secondary" style="margin-top: var(--space-md);">Try Again</a>
                </div>
            `;
        }

        async function loadDashboard(address) {
            currentUserAddress = address;
            localStorage.setItem('garo_wallet', address);

            try {
                const [memoriesRes, xpRes] = await Promise.all([
                    fetch(`/api/memories?address=${address}`),
                    fetch(`/api/xp?address=${address}`)
                ]);

                const memoriesData = await memoriesRes.json();
                const xpData = await xpRes.json();

                const memories = memoriesData.memories || [];
                const xp = xpData.success ? xpData : { xp: 0, streak: 0, level: { name: 'New Fan' }, progress: 0 };

                renderDashboard(memories, address, xp);
            } catch (e) {
                renderDashboard([], address, { xp: 0, streak: 0, level: { name: 'New Fan' }, progress: 0 });
            }
        }

        function renderDashboard(memories, address, xpData) {
            const count = memories.length;
            const level = getLevel(count);

            const galleryHtml = memories.length > 0
                ? `<div class="gallery">${memories.map(m => `
                    <div class="memory-item">
                        <img src="${m.image}" alt="${m.name}" loading="lazy" onerror="this.src='https://via.placeholder.com/150/141423/a855f7?text=‚ú®'">
                        <div class="memory-date">${new Date(m.date).toLocaleDateString('en', { month: 'short', day: 'numeric' })}</div>
                    </div>
                `).join('')}</div>`
                : `<div class="empty-state">
                    <div class="empty-icon">üì∏</div>
                    <p>Your collection is empty</p>
                    <p style="font-size: 0.8rem; margin-top: var(--space-sm); opacity: 0.6;">Capture your first memory at an event!</p>
                </div>`;

            const benefitsHtml = BENEFITS.map(b => {
                const unlocked = count >= b.required;
                return `<div class="reward-item ${unlocked ? 'unlocked' : 'locked'}">
                    <span class="reward-icon">${b.icon}</span>
                    <span class="reward-text">${b.text}</span>
                    <span class="reward-status">${unlocked ? '‚úì' : `${b.required} needed`}</span>
                </div>`;
            }).join('');

            document.getElementById('content').innerHTML = `
                <div class="hero animate-fade-in">
                    <div class="avatar">${level.emoji}</div>
                    <h1 class="level-title text-gradient">${level.name}</h1>
                    <p class="memory-count"><strong>${count}</strong> memories collected</p>
                </div>

                <div class="xp-card animate-slide-up">
                    <div class="xp-header">
                        <div class="xp-amount">${xpData.xp || 0}<span>XP</span></div>
                        ${xpData.streak > 0 ? `<div class="streak-badge">üî• ${xpData.streak}</div>` : ''}
                    </div>
                    <div class="xp-progress">
                        <div class="progress">
                            <div class="progress-fill" style="width: ${xpData.progress || 0}%"></div>
                        </div>
                    </div>
                    <div class="xp-levels">
                        <span>${xpData.level?.name || 'New Fan'}</span>
                        <span>${xpData.nextLevel ? '‚Üí ' + xpData.nextLevel.name : '‚ú® MAX'}</span>
                    </div>
                </div>

                <div style="animation: slideUp 0.5s ease-out 0.2s both;">
                    <h3 class="section-title">My Memories</h3>
                    ${galleryHtml}
                </div>

                <button class="btn btn-primary" style="width: 100%; margin-bottom: var(--space-lg);" onclick="toggleQR()">
                    Show Access Pass
                </button>

                <div class="qr-section" id="qrSection">
                    <div class="qr-label">ACCESS PASS</div>
                    <div id="qrcode"></div>
                    <p class="qr-hint">Show at entrance for verification</p>
                </div>

                <div style="animation: slideUp 0.5s ease-out 0.3s both;">
                    <h3 class="section-title">Rewards</h3>
                    <div class="rewards-list">${benefitsHtml}</div>
                </div>

                <div style="animation: slideUp 0.5s ease-out 0.4s both;">
                    <h3 class="section-title">Explore</h3>
                    <div class="nav-grid">
                        <button class="nav-btn" onclick="shareProfile()">üì§ Share</button>
                        <button class="nav-btn" onclick="location.href='/leaderboard.html'">üèÜ Leaderboard</button>
                        <button class="nav-btn" onclick="location.href='/story.html?a=${address}'">üì∏ Story</button>
                        <button class="nav-btn" onclick="location.href='/downloads.html'">üéµ Downloads</button>
                        <button class="nav-btn" onclick="location.href='/inject.html'" style="grid-column: span 2;">‚ú® Capture Memory</button>
                    </div>
                </div>
            `;

            // Generate QR
            setTimeout(() => {
                const qr = document.getElementById("qrcode");
                if (qr) {
                    new QRCode(qr, {
                        text: address,
                        width: 160,
                        height: 160,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                }
            }, 100);
        }

        function toggleQR() {
            const qr = document.getElementById('qrSection');
            qr.style.display = qr.style.display === 'block' ? 'none' : 'block';
        }

        function shareProfile() {
            const url = `${location.origin}/profile.html?a=${currentUserAddress}`;
            if (navigator.share) {
                navigator.share({ title: 'My GŒõRO Collection', text: 'Check out my memories!', url });
            } else {
                navigator.clipboard.writeText(url);
                alert('Link copied!');
            }
        }

        window.addEventListener('load', init);
    </script>
</body>

</html>