<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>GŒõRO | Admin</title>
    <link rel="stylesheet" href="/styles.css">
    <meta name="theme-color" content="#08080f">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        .page {
            padding: var(--space-lg);
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-xl);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .back-btn {
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: var(--space-sm) var(--space-md);
            color: var(--text-muted);
            cursor: pointer;
        }

        .page-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
        }

        .stat-value.purple {
            color: var(--accent-primary);
        }

        .stat-value.cyan {
            color: var(--accent-secondary);
        }

        .stat-value.green {
            color: var(--success);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: var(--space-xs);
        }

        /* Two Column Layout */
        .layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
        }

        @media (max-width: 768px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }

        /* Panel */
        .panel {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: var(--space-lg);
        }

        .panel-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-lg);
        }

        /* QR Section */
        .qr-container {
            text-align: center;
            padding: var(--space-lg);
            background: white;
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-lg);
        }

        .qr-container canvas {
            max-width: 100%;
        }

        .event-input {
            margin-bottom: var(--space-md);
        }

        .event-input label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: var(--space-xs);
        }

        .event-input input {
            width: 100%;
            padding: var(--space-md);
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: monospace;
            font-size: 0.875rem;
        }

        .generate-btn {
            width: 100%;
            padding: var(--space-md);
            background: var(--accent-gradient);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: var(--space-lg);
        }

        /* Activity Log */
        .activity-log {
            max-height: 300px;
            overflow-y: auto;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.75rem;
        }

        .log-entry {
            display: flex;
            justify-content: space-between;
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--border-subtle);
            color: var(--text-secondary);
        }

        .log-entry.mint {
            color: var(--accent-primary);
        }

        .log-entry.scan {
            color: var(--accent-secondary);
        }

        .log-entry.system {
            color: var(--text-muted);
        }

        /* Chart */
        .chart-container {
            height: 150px;
            margin-bottom: var(--space-lg);
        }
    </style>
</head>

<body class="safe-area-top safe-area-bottom">
    <div class="page">
        <div class="header">
            <div class="header-left">
                <button class="back-btn" onclick="location.href='/dashboard.html'">‚Üê</button>
                <h1 class="page-title">üëÅÔ∏è God Mode</h1>
            </div>
            <div class="status-dot"></div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value purple" id="statMints">0</div>
                <div class="stat-label">Mints</div>
            </div>
            <div class="stat-card">
                <div class="stat-value cyan" id="statScans">0</div>
                <div class="stat-label">Scans</div>
            </div>
            <div class="stat-card">
                <div class="stat-value green" id="statUsers">0</div>
                <div class="stat-label">Users</div>
            </div>
        </div>

        <div class="layout">
            <div class="panel">
                <h3 class="panel-title">Stage QR Generator</h3>

                <div class="event-input">
                    <label>Event ID</label>
                    <input type="text" id="eventId" value="GENESIS_2025">
                </div>

                <button class="generate-btn" onclick="generateQR()">Generate QR</button>

                <div class="qr-container" id="qrContainer">
                    <p style="color: #666; font-size: 0.8rem;">Click generate to create QR</p>
                </div>
            </div>

            <div class="panel">
                <h3 class="panel-title">Activity (Last 8h)</h3>
                <div class="chart-container">
                    <canvas id="chart"></canvas>
                </div>

                <h3 class="panel-title">Live Feed</h3>
                <div class="activity-log" id="log">
                    <div class="log-entry system">
                        <span>Initializing...</span>
                        <span>SYSTEM</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // PIN Protection for Admin
        const ADMIN_PIN = 'ADMIN2025';
        const params = new URLSearchParams(location.search);
        const pin = params.get('pin');

        if (pin === ADMIN_PIN) {
            sessionStorage.setItem('godmode_auth', 'true');
        } else if (sessionStorage.getItem('godmode_auth') !== 'true') {
            alert('‚õî Admin access required');
            location.href = '/dashboard.html';
        }

        let chart = null;

        async function init() {
            log('Connecting to backend...', 'system');
            await fetchStats();
            setInterval(fetchStats, 10000);
            log('Live feed active', 'system');
        }

        async function fetchStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();

                if (data.success) {
                    document.getElementById('statMints').textContent = data.stats.mints;
                    document.getElementById('statScans').textContent = data.stats.scans;
                    document.getElementById('statUsers').textContent = data.stats.uniqueUsers;

                    updateChart(data.recentActivity || []);

                    if (data.recentActivity?.length > 0) {
                        const newest = data.recentActivity[0];
                        log(`${newest.type.toUpperCase()}: ${newest.wallet}`, newest.type);
                    }
                }
            } catch (e) {
                log('Connection error', 'system');
            }
        }

        function log(msg, type) {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span>${msg}</span><span>${type.toUpperCase()}</span>`;
            logEl.insertBefore(entry, logEl.firstChild);
            if (logEl.children.length > 30) logEl.lastChild.remove();
        }

        function updateChart(activity) {
            const ctx = document.getElementById('chart').getContext('2d');

            const hours = {};
            for (let i = 7; i >= 0; i--) {
                const h = new Date();
                h.setHours(h.getHours() - i);
                hours[h.getHours()] = { mints: 0, scans: 0 };
            }

            activity.forEach(a => {
                const hour = new Date(a.time).getHours();
                if (hours[hour]) {
                    if (a.type === 'mint') hours[hour].mints++;
                    else hours[hour].scans++;
                }
            });

            const labels = Object.keys(hours).map(h => `${h}:00`);
            const mintData = Object.values(hours).map(h => h.mints);
            const scanData = Object.values(hours).map(h => h.scans);

            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Mints', data: mintData, backgroundColor: 'rgba(168, 85, 247, 0.7)', borderRadius: 4 },
                        { label: 'Scans', data: scanData, backgroundColor: 'rgba(6, 182, 212, 0.7)', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'rgba(255,255,255,0.4)', font: { size: 10 } } },
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'rgba(255,255,255,0.4)' }, beginAtZero: true }
                    }
                }
            });
        }

        function generateQR() {
            const eventId = document.getElementById('eventId').value;
            const container = document.getElementById('qrContainer');
            container.innerHTML = '';

            const url = `${location.origin}/inject.html?event=${eventId}`;

            new QRCode(container, {
                text: url,
                width: 180,
                height: 180,
                colorDark: '#000',
                colorLight: '#fff'
            });

            log(`QR generated: ${eventId}`, 'system');
        }

        window.addEventListener('load', init);
    </script>
</body>

</html>