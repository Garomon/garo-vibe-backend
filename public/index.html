<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GŒõRO VIBE CENTER</title>

    <!-- POLYFILLS (Critical for Web3/Solana in Browser) -->
    <script>
        window.global = window;
        window.process = { env: { DEBUG: undefined }, version: '' };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/buffer/6.0.3/buffer.min.js"></script>
    <script>
        if (window.buffer) window.Buffer = window.buffer.Buffer;
    </script>

    <!-- Web3Auth SDKs - Stable Version 8.12.4 (All packages matching) -->
    <script src="https://cdn.jsdelivr.net/npm/@web3auth/no-modal@8.12.4/dist/noModal.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@web3auth/solana-provider@8.12.4/dist/solanaProvider.umd.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/@web3auth/openlogin-adapter@8.12.4/dist/openloginAdapter.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@web3auth/base@8.12.4/dist/base.umd.min.js"></script>

    <!-- Solana Web3 used for some utils -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

    <style>
        :root {
            --neon-purple: #bc13fe;
            --neon-green: #17e890;
            --bg-dark: #0a0a0f;
            --panel-bg: #13131f;
            --google-red: #ea4335;
            --twitter-blue: #1DA1F2;
        }

        body {
            background-color: var(--bg-dark);
            color: white;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            background: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #000000 100%);
        }

        .container {
            background: var(--panel-bg);
            padding: 2.5rem;
            border: 2px solid var(--neon-purple);
            box-shadow: 0 0 30px rgba(188, 19, 254, 0.3);
            border-radius: 16px;
            text-align: center;
            width: 90%;
            max-width: 380px;
            position: relative;
            backdrop-filter: blur(10px);
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 2rem;
            text-shadow: 0 0 15px var(--neon-purple);
            letter-spacing: 4px;
            font-weight: 800;
        }

        .subtitle {
            margin-bottom: 2rem;
            font-size: 0.9rem;
            color: #aaa;
            line-height: 1.4;
        }

        /* Social Buttons */
        .btn-social {
            width: 100%;
            padding: 16px;
            margin-bottom: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
            font-family: 'Verdana', sans-serif;
            /* Cleaner font for buttons */
        }

        .btn-google {
            background: white;
            color: #444;
        }

        .btn-google:hover {
            background: #f1f1f1;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
        }

        .btn-twitter {
            background: black;
            /* X branding */
            color: white;
            border: 1px solid #333;
        }

        .btn-twitter:hover {
            background: #111;
            border-color: #555;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
        }

        /* Status & Loading */
        #status {
            margin-top: 25px;
            min-height: 20px;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .loading-spinner {
            color: var(--neon-purple);
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0.5;
            }
        }

        .success-box {
            border: 1px solid var(--neon-green);
            padding: 15px;
            border-radius: 8px;
            background: rgba(23, 232, 144, 0.05);
            margin-top: 20px;
        }

        a {
            color: var(--neon-green);
            text-decoration: none;
            border-bottom: 1px dotted var(--neon-green);
        }

        /* Glitch Animation */
        .glitch-text {
            position: relative;
        }

        .glitch-text::before,
        .glitch-text::after {
            content: "GŒõRO VIBE";
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
        }

        .glitch-text:hover::before {
            animation: glitch-anim-1 0.4s infinite linear alternate-reverse;
            clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
            transform: translate(-2px);
            opacity: 0.7;
        }

        .glitch-text:hover::after {
            animation: glitch-anim-2 0.4s infinite linear alternate-reverse;
            clip-path: polygon(0 60%, 100% 60%, 100% 100%, 0 100%);
            transform: translate(2px);
            opacity: 0.7;
        }

        @keyframes glitch-anim-1 {
            0% {
                clip-path: inset(20% 0 80% 0);
            }

            100% {
                font-size: 0.8rem;
                opacity: 0.7;
                transition: opacity 0.2s;
            }

            .link-sub:hover {
                opacity: 1;
                text-decoration: underline;
            }

            /* --- Scanlines Effect --- */
            .scanlines {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0) 50%, rgba(0, 0, 0, 0.1) 50%, rgba(0, 0, 0, 0.1));
                background-size: 100% 4px;
                pointer-events: none;
                z-index: 5;
                opacity: 0.3;
            }

            /* --- Mobile Adjustments --- */
            @media (max-width: 480px) {
                .glitch-text {
                    font-size: 2.5rem;
                }
            }
    </style>
</head>

<body>

    <div class="scanlines"></div>
    <div class="ambient-glow"></div>

    <div class="app-container">

        <!-- HEADER -->
        <div class="logo-area">
            <div class="glitch-text">GŒõRO</div>
            <div class="subtitle">GENESIS ACCESS</div>
        </div>

        <!-- LOGIN CARD -->
        <div id="loginArea" class="glass-card">
            <p style="margin-bottom: 25px; font-weight: 500;">Conecta para reclamar tu VIBE</p>

            <button class="btn-social btn-google" onclick="login('google')">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" class="icon"
                    alt="G">
                Continuar con Google
            </button>

            <button class="btn-social btn-x" onclick="login('twitter')">
                <svg class="icon" viewBox="0 0 24 24" fill="white">
                    <path
                        d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z">
                    </path>
                </svg>
                Continuar con X
            </button>

            <div style="margin-top: 20px; font-size: 0.75rem; color: var(--text-muted); opacity: 0.6;">
                Powered by Solana ‚Ä¢ Gas-Free
            </div>
        </div>

        <!-- STATUS / SUCCESS AREA -->
        <div id="statusArea" style="display:none; transition: opacity 0.5s;">
            <div id="statusContent"></div>
        </div>

    </div>

    <!-- LOGIC -->
    <script>
        // Polyfills required by Web3Auth/Solana
        window.global = window;
        window.process = { env: { DEBUG: undefined }, version: '' };

        // Configuration
        const CLIENT_ID = "BM-MYF10MnxIke1bEqjAr39dibU5kHDMVNLepOM0prcajw67H-fhIeXa953MbVZdHeTwyZr3SMEyLjOG3-Q1mMc"; // Production ID
        const NETWORK = "sapphire_devnet";

        let web3auth = null;
        let privateKeyProvider = null;

        // UI Helpers
        const log = (msg) => console.log(`[VIBE_LOG]: ${msg}`);

        function showLoading(msg) {
            const el = document.getElementById('statusArea');
            el.style.display = 'block';
            document.getElementById('loginArea').style.display = 'none';
            document.getElementById('statusContent').innerHTML = `
                <div class="glass-card">
                    <div class="spinner"></div><br><br>
                    ${msg}
                </div>
            `;
        }

        function showCards() {
            document.getElementById('statusArea').style.display = 'none';
            document.getElementById('loginArea').style.display = 'block';
            // Animation reset if needed
        }

        async function init() {
            try {
                // Determine Classes handles for UMD 
                const NoModal = window.NoModal?.Web3AuthNoModal || window.Web3AuthNoModal;
                const SolanaProvider = window.SolanaProvider?.SolanaPrivateKeyProvider || window.SolanaPrivateKeyProvider;
                const OpenloginAdapter = window.OpenloginAdapter?.OpenloginAdapter || window.OpenloginAdapter;
                const CHAIN_NAMESPACES = window.NoModal?.CHAIN_NAMESPACES || { SOLANA: "solana" };

                if (!NoModal || !SolanaProvider || !OpenloginAdapter) {
                    throw new Error("Librer√≠as Web3Auth no cargaron correctamente.");
                }

                // 1. Setup Chain Config
                const chainConfig = {
                    chainNamespace: CHAIN_NAMESPACES.SOLANA,
                    chainId: "0x3", // Use 0x1 for Mainnet, 0x3 for Devnet
                    rpcTarget: "https://api.devnet.solana.com",
                    displayName: "Solana Devnet",
                    blockExplorer: "https://explorer.solana.com",
                    ticker: "SOL",
                    tickerName: "Solana",
                };

                // 2. Init Provider
                privateKeyProvider = new SolanaProvider({ config: { chainConfig } });

                // 3. Init Web3Auth
                web3auth = new NoModal({
                    clientId: CLIENT_ID,
                    web3AuthNetwork: NETWORK,
                    chainConfig,
                });

                // 4. Configure Adapter (Redirect Mode for Mobile)
                const adapter = new OpenloginAdapter({
                    privateKeyProvider,
                    adapterSettings: {
                        uxMode: "redirect",
                        redirectUrl: window.location.href,
                    }
                });
                web3auth.configureAdapter(adapter);

                // 5. Initialize
                await web3auth.init();

                // 6. Check Login Status
                if (web3auth.connected) {
                    handleSuccess();
                } else {
                    showCards();
                }

            } catch (error) {
                console.error(error);
                document.getElementById('statusContent').innerHTML = `<p style="color:red">Error Init: ${error.message}</p>`;
                document.getElementById('statusArea').style.display = 'block';
            }
        }

        async function login(provider) {
            if (!web3auth) return;
            try {
                await web3auth.connectTo(window.OpenloginAdapter.WALLET_ADAPTERS.OPENLOGIN, {
                    loginProvider: provider,
                });
            } catch (error) {
                console.error("Login Error:", error);
            }
        }

        async function logout() {
            if (!web3auth) return;
            await web3auth.logout();
            window.location.reload();
        }

        // --- CORE LOGIC ---

        async function handleSuccess() {
            showLoading("Verificando identidad...");

            try {
                // Get User Wallet
                const accounts = await web3auth.provider.request({ method: "getAccounts" });
                const userAddress = accounts[0];
                log("User Address: " + userAddress);

                // --- DOUBLE MINT PROTECTION (LocalStorage) ---
                const localData = localStorage.getItem('vibe_minted_' + userAddress);

                if (localData) {
                    showSuccessState(localData, true); // True = Already Minted
                } else {
                    await mintNFT(userAddress);
                }

            } catch (e) {
                log("Wallet Error: " + e.message);
                document.getElementById('statusContent').innerText = "Error obteniendo wallet: " + e.message;
            }
        }

        async function mintNFT(address) {
            showLoading(`Minteando VIBE para:<br><small style="font-family:monospace">${address.slice(0, 4)}...${address.slice(-4)}</small>`);

            try {
                const response = await fetch('/mint', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ receiverAddress: address })
                });

                const data = await response.json();

                if (data.success) {
                    // Save to LocalStorage
                    localStorage.setItem('vibe_minted_' + address, data.explorer);
                    showSuccessState(data.explorer, false); // False = Just Minted
                } else {
                    throw new Error(data.error || "Error desconocido");
                }

            } catch (error) {
                log("API Error: " + error.message);
                document.getElementById('statusContent').innerHTML = `
                    <div class="glass-card" style="border-color: #ff3333;">
                        ‚ùå <strong>ERROR</strong><br>
                        ${error.message}<br><br>
                        <button class="btn-social" onclick="window.location.reload()">Reintentar</button>
                    </div>
                `;
            }
        }

        function showSuccessState(explorerLink, isCached) {
            const title = isCached ? "YA ERES MIEMBRO" : "¬°ACCESO CONCEDIDO!";
            const desc = isCached ? "Tu pase Genesis ya est√° activo." : "Bienvenido al ecosistema GŒõRO.";

            // Image from IPFS (Hardcoded for now based on current metadata)
            const imgUrl = "https://ipfs.io/ipfs/bafkreicf2uskmsrm7sgqvy7hmign255iedvab4x5s5q4vxe2mcluc7yvhm";

            document.getElementById('statusContent').innerHTML = `
                <div class="glass-card nft-reveal">
                    <img src="${imgUrl}" class="nft-image" alt="NFT">
                    <div class="success-title">${title}</div>
                    <div class="success-desc">${desc}</div>
                    
                    <a href="${explorerLink}" target="_blank" style="text-decoration:none;">
                        <button class="btn-social btn-primary">VER EN BLOCKCHAIN ‚Üó</button>
                    </a>

                    <div style="margin-top:20px; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">
                        <p style="margin:0; font-size:0.8rem; color:var(--text-muted)">Pr√≥ximamente:</p>
                        <button class="btn-social" style="margin-top:10px; opacity:0.5; cursor:not-allowed;">
                            üîê ACCEDER A MI GALER√çA
                        </button>
                    </div>

                    <a href="#" onclick="logout()" class="link-sub">Cerrar Sesi√≥n</a>
                </div>
            `;

            // Optional: Play Sound here
        }

        // Start
        window.addEventListener('load', init);

    </script>
</body>

</html>