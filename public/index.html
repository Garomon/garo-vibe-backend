<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GΛRO VIBE CENTER</title>

    <!-- POLYFILLS (Critical for Web3/Solana in Browser) -->
    <script>
        window.global = window;
        window.process = { env: { DEBUG: undefined }, version: '' };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/buffer/6.0.3/buffer.min.js"></script>
    <script>
        if (window.buffer) window.Buffer = window.buffer.Buffer;
    </script>

    <!-- Web3Auth SDKs - Correct Bundle for NoModal -->
    <script src="https://cdn.jsdelivr.net/npm/@web3auth/no-modal@9.4.2/dist/noModal.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@web3auth/solana-provider@9.4.2/dist/solanaProvider.umd.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/@web3auth/openlogin-adapter@9.4.2/dist/openloginAdapter.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@web3auth/base@9.4.2/dist/base.umd.min.js"></script>

    <!-- Solana Web3 used for some utils -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

    <style>
        :root {
            --neon-purple: #bc13fe;
            --neon-green: #17e890;
            --bg-dark: #0a0a0f;
            --panel-bg: #13131f;
            --google-red: #ea4335;
            --twitter-blue: #1DA1F2;
        }

        body {
            background-color: var(--bg-dark);
            color: white;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            background: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #000000 100%);
        }

        .container {
            background: var(--panel-bg);
            padding: 2.5rem;
            border: 2px solid var(--neon-purple);
            box-shadow: 0 0 30px rgba(188, 19, 254, 0.3);
            border-radius: 16px;
            text-align: center;
            width: 90%;
            max-width: 380px;
            position: relative;
            backdrop-filter: blur(10px);
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 2rem;
            text-shadow: 0 0 15px var(--neon-purple);
            letter-spacing: 4px;
            font-weight: 800;
        }

        .subtitle {
            margin-bottom: 2rem;
            font-size: 0.9rem;
            color: #aaa;
            line-height: 1.4;
        }

        /* Social Buttons */
        .btn-social {
            width: 100%;
            padding: 16px;
            margin-bottom: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
            font-family: 'Verdana', sans-serif;
            /* Cleaner font for buttons */
        }

        .btn-google {
            background: white;
            color: #444;
        }

        .btn-google:hover {
            background: #f1f1f1;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
        }

        .btn-twitter {
            background: black;
            /* X branding */
            color: white;
            border: 1px solid #333;
        }

        .btn-twitter:hover {
            background: #111;
            border-color: #555;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
        }

        /* Status & Loading */
        #status {
            margin-top: 25px;
            min-height: 20px;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .loading-spinner {
            color: var(--neon-purple);
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0.5;
            }
        }

        .success-box {
            border: 1px solid var(--neon-green);
            padding: 15px;
            border-radius: 8px;
            background: rgba(23, 232, 144, 0.05);
            margin-top: 20px;
        }

        a {
            color: var(--neon-green);
            text-decoration: none;
            border-bottom: 1px dotted var(--neon-green);
        }

        /* Glitch Animation */
        .glitch-text {
            position: relative;
        }

        .glitch-text::before,
        .glitch-text::after {
            content: "GΛRO VIBE";
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
        }

        .glitch-text:hover::before {
            animation: glitch-anim-1 0.4s infinite linear alternate-reverse;
            clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
            transform: translate(-2px);
            opacity: 0.7;
        }

        .glitch-text:hover::after {
            animation: glitch-anim-2 0.4s infinite linear alternate-reverse;
            clip-path: polygon(0 60%, 100% 60%, 100% 100%, 0 100%);
            transform: translate(2px);
            opacity: 0.7;
        }

        @keyframes glitch-anim-1 {
            0% {
                clip-path: inset(20% 0 80% 0);
            }

            100% {
                clip-path: inset(60% 0 10% 0);
            }
        }

        @keyframes glitch-anim-2 {
            0% {
                clip-path: inset(10% 0 60% 0);
            }

            100% {
                clip-path: inset(80% 0 5% 0);
            }
        }

        /* DEBUG CONSOLE */
        #debug-console {
            display: block;
            /* Enabled for debugging */
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 150px;
            background: rgba(0, 0, 0, 0.9);
            color: #0f0;
            font-family: monospace;
            font-size: 10px;
            overflow-y: scroll;
            padding: 10px;
            z-index: 9999;
            text-align: left;
            border-top: 1px solid #333;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1 class="glitch-text">GΛRO VIBE</h1>
        <div class="subtitle">Identifícate para acceder al<br>Genesis Drop 2025</div>

        <div id="loginArea">
            <button class="btn-social btn-google" onclick="login('google')">
                <!-- SVG Icon Google -->
                <svg width="18" height="18" viewBox="0 0 18 18" style="margin-right:8px">
                    <path
                        d="M17.64 9.2c0-.637-.057-1.252-.164-1.841H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"
                        fill="#4285F4" />
                    <path
                        d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.715H.957v2.332A8.997 8.997 0 0 0 9 18z"
                        fill="#34A853" />
                    <path
                        d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"
                        fill="#FBBC05" />
                    <path
                        d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.272C4.672 5.141 6.656 3.58 9 3.58z"
                        fill="#EA4335" />
                </svg>
                Continuar con Google
            </button>
            <button class="btn-social btn-twitter" onclick="login('twitter')">
                <!-- SVG Icon X -->
                <svg width="18" height="18" viewBox="0 0 24 24" fill="white" style="margin-right:8px">
                    <path
                        d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
                </svg>
                Continuar con X
            </button>
        </div>

        <div id="status"></div>
    </div>

    <div id="debug-console"></div>

    <script>
        // --- LOGGER HELPER ---
        // To help debug on mobile devices where console isn't visible
        function log(msg) {
            console.log(msg);
            const debugEl = document.getElementById('debug-console');
            // Uncomment next line to show debug console on screen
            // debugEl.style.display = 'block'; 
            debugEl.innerHTML += `> ${msg}<br>`;
        }

        window.onerror = function (msg, url, line) {
            log(`ERROR: ${msg} (${line})`);
            document.getElementById('status').innerText = `Error interno: ${msg}`;
            return false;
        };

        // --- CONFIG ---
        const CLIENT_ID = "BM-MYF10MnxIke1bEqjAr39dibU5kHDMVNLepOM0prcajw67H-fhIeXa953MbvZdHeTwyZr3SMEyLjOG3-Q1mMc";

        let web3auth = null;

        async function init() {
            try {
                log("Iniciando Web3Auth...");

                // 1. Acceder a los globales expuestos por los UMD bundles
                // @web3auth/no-modal expone 'window.NoModal' o 'window.Web3AuthNoModal'
                // Revisa network tab si falla, pero el estándar suele ser window.NoModal

                const { Web3AuthNoModal } = window.NoModal;
                const { SolanaPrivateKeyProvider } = window.SolanaProvider;
                const { OpenloginAdapter } = window.OpenloginAdapter;
                const { CHAIN_NAMESPACES } = window.Base;

                if (!Web3AuthNoModal || !SolanaPrivateKeyProvider || !OpenloginAdapter) {
                    throw new Error("SDKs no cargados correctamente. Revisa tu conexión.");
                }

                const chainConfig = {
                    chainNamespace: CHAIN_NAMESPACES.SOLANA,
                    chainId: "0x3", // Devnet
                    rpcTarget: "https://api.devnet.solana.com",
                    displayName: "Solana Devnet",
                    blockExplorer: "https://explorer.solana.com",
                    ticker: "SOL",
                    tickerName: "Solana",
                };

                // 2. Instancia Principal
                web3auth = new Web3AuthNoModal({
                    clientId: CLIENT_ID,
                    chainConfig,
                    web3AuthNetwork: "sapphire_devnet",
                });

                // 3. Configurar Provider
                const privateKeyProvider = new SolanaPrivateKeyProvider({ config: { chainConfig } });

                // 4. Configurar Adapter
                const openloginAdapter = new OpenloginAdapter({
                    privateKeyProvider,
                    adapterSettings: {
                        uxMode: "popup",
                    }
                });
                web3auth.configureAdapter(openloginAdapter);

                // 5. Init
                await web3auth.init();
                log("Web3Auth Inicializado.");

                if (web3auth.connected) {
                    handleSuccess();
                }

            } catch (error) {
                log("INIT ERROR: " + error.message);
                document.getElementById('status').innerText = "System Init Fail: " + error.message;
            }
        }

        async function login(provider) {
            if (!web3auth) {
                log("Web3Auth no listo aún.");
                return;
            }

            document.getElementById('status').innerHTML = '<span class="loading-spinner">Conectando...</span>';

            try {
                await web3auth.connectTo("openlogin", {
                    loginProvider: provider,
                });

                if (web3auth.connected) {
                    handleSuccess();
                }
            } catch (error) {
                log("LOGIN ERROR: " + error.message);
                document.getElementById('status').innerText = "Login Cancelado.";
            }
        }

        async function handleSuccess() {
            document.getElementById('loginArea').style.display = 'none';
            document.getElementById('status').innerHTML = '<span class="loading-spinner">Autenticado. Verificando identidad...</span>';

            try {
                // Obtener llaves usando el provider de Solana
                // El provider de web3auth cumple la interfaz, pero para request simple:
                const accounts = await web3auth.provider.request({ method: "getAccounts" });
                const userAddress = accounts[0];

                log("Wallet: " + userAddress);
                await mintNFT(userAddress);

            } catch (e) {
                log("WALLET ERROR: " + e.message);
                document.getElementById('status').innerText = "Error obteniendo wallet.";
            }
        }

        async function mintNFT(address) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<span class="loading-spinner">Minteando para:<br><small>${address.slice(0, 6)}...${address.slice(-4)}</small></span>`;

            try {
                const response = await fetch('/mint', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ receiverAddress: address })
                });

                const data = await response.json();

                if (data.success) {
                    statusDiv.innerHTML = `
                        <div class="success-box">
                            ✅ <strong>NFT ENVIADO</strong><br>
                            <span style="font-size:0.8rem">Bienvenido al ecosistema VIBE.</span><br><br>
                            <a href="${data.explorer}" target="_blank">VER EN BLOCKCHAIN ↗</a>
                        </div>
                        <br>
                        <button onclick="logout()" style="background:transparent; border:1px solid #333; color:#555; padding:5px 10px; cursor:pointer; font-size:0.7rem; border-radius:4px;">Salir</button>
                    `;
                } else {
                    throw new Error(data.error || "Error desconocido");
                }

            } catch (error) {
                log("API ERROR: " + error.message);
                statusDiv.innerHTML = `<span style="color:var(--google-red)">❌ ERROR: ${error.message}</span>`;
            }
        }

        async function logout() {
            await web3auth.logout();
            window.location.reload();
        }

        // Delay init slightly to ensure scripts load
        window.onload = init;
    </script>
</body>

</html>