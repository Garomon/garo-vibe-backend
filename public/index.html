<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>GΛRO | Sign In</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#08080f">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <link rel="stylesheet" href="/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@web3auth/modal@9.6.0/dist/modal.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@web3auth/solana-provider@9.6.0/dist/solanaProvider.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/buffer/6.0.3/buffer.min.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@1.91.8/lib/index.iife.min.js"></script>

    <style>
        .login-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-xl);
            text-align: center;
        }

        .logo {
            font-size: 3rem;
            font-weight: 900;
            margin-bottom: var(--space-sm);
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-bottom: var(--space-2xl);
        }

        /* Terminal */
        .terminal {
            width: 100%;
            max-width: 360px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            overflow: hidden;
            margin-bottom: var(--space-xl);
        }

        .terminal-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-md);
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid var(--border-subtle);
        }

        .terminal-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .terminal-dot.red {
            background: #ef4444;
        }

        .terminal-dot.yellow {
            background: #f59e0b;
        }

        .terminal-dot.green {
            background: #22c55e;
        }

        .terminal-title {
            flex: 1;
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .terminal-body {
            padding: var(--space-lg);
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 0.8rem;
            color: var(--text-secondary);
            min-height: 120px;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-line {
            margin-bottom: var(--space-sm);
            display: flex;
            gap: var(--space-sm);
            animation: slideUp 0.3s ease-out;
        }

        .log-prefix {
            color: var(--accent-primary);
        }

        .log-line.success {
            color: var(--success);
        }

        .log-line.error {
            color: var(--error);
        }

        .log-line.info {
            color: var(--accent-secondary);
        }

        /* Login Buttons */
        .login-options {
            width: 100%;
            max-width: 360px;
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-md);
            padding: var(--space-lg);
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .login-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--border-glow);
            transform: translateY(-2px);
        }

        .login-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .login-btn svg {
            width: 20px;
            height: 20px;
        }

        .divider {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-subtle);
        }

        .back-link {
            position: fixed;
            top: var(--space-lg);
            left: var(--space-lg);
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            transition: color var(--transition-fast);
        }

        .back-link:hover {
            color: var(--text-primary);
        }
    </style>
</head>

<body>
    <a href="/onboarding.html" class="back-link">← Back</a>

    <div class="login-container">
        <h1 class="logo text-gradient">GΛRO</h1>
        <p class="subtitle">Sign in to access your collection</p>

        <div class="terminal">
            <div class="terminal-header">
                <span class="terminal-dot red"></span>
                <span class="terminal-dot yellow"></span>
                <span class="terminal-dot green"></span>
                <span class="terminal-title">session.log</span>
            </div>
            <div class="terminal-body" id="logs">
                <div class="log-line"><span class="log-prefix">$</span> awaiting_authentication...</div>
            </div>
        </div>

        <div class="login-options">
            <button class="login-btn" id="loginBtn" onclick="login()">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                        fill="#4285F4" />
                    <path
                        d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                        fill="#34A853" />
                    <path
                        d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                        fill="#FBBC05" />
                    <path
                        d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                        fill="#EA4335" />
                </svg>
                Continue with Google
            </button>
        </div>
    </div>

    <script>
        const CLIENT_ID = "BLVk4nc6lfY2oRnqR7tDjkZn-Kpv8JbgS3lE6iDDWNh5zhIW2WdM3_h6fBu8n92Y0FuHOflV0TwIKc6yPNK0cSI";
        const NETWORK = "sapphire_devnet";
        let web3auth = null;

        function log(msg, type = '') {
            const logs = document.getElementById('logs');
            const line = document.createElement('div');
            line.className = `log-line ${type}`;
            line.innerHTML = `<span class="log-prefix">$</span> ${msg}`;
            logs.appendChild(line);
            logs.scrollTop = logs.scrollHeight;
        }

        async function initWeb3Auth() {
            try {
                log('initializing_web3auth...');

                const Web3AuthModal = window.Modal?.Web3Auth || window.Web3Auth;
                const SolanaProvider = window.SolanaProvider?.SolanaPrivateKeyProvider || window.SolanaPrivateKeyProvider;

                const chainConfig = {
                    chainNamespace: "solana",
                    chainId: "0x3",
                    rpcTarget: "https://api.devnet.solana.com",
                    displayName: "Solana Devnet",
                    blockExplorer: "https://explorer.solana.com",
                    ticker: "SOL",
                    tickerName: "Solana",
                };

                const privateKeyProvider = new SolanaProvider({ config: { chainConfig } });

                web3auth = new Web3AuthModal({
                    clientId: CLIENT_ID,
                    web3AuthNetwork: NETWORK,
                    chainConfig,
                    privateKeyProvider,
                    uiConfig: { mode: "dark", uxMode: "redirect" }
                });

                await web3auth.initModal();
                log('ready', 'success');

                if (web3auth.connected) {
                    log('session_found', 'info');
                    await handleConnected();
                }

            } catch (e) {
                log('error: ' + e.message, 'error');
            }
        }

        async function login() {
            const btn = document.getElementById('loginBtn');
            btn.disabled = true;

            try {
                log('connecting...');
                await web3auth.connect();
                await handleConnected();
            } catch (e) {
                log('auth_failed: ' + e.message, 'error');
                btn.disabled = false;
            }
        }

        async function handleConnected() {
            log('authenticated', 'success');

            const accounts = await web3auth.provider.request({ method: "getAccounts" });
            const address = accounts[0];
            log('wallet: ' + address.slice(0, 8) + '...', 'info');
            localStorage.setItem('garo_wallet', address);

            // Check if new user
            log('checking_membership...');
            const res = await fetch(`/verify?address=${address}`);
            const data = await res.json();

            if (data.valid) {
                log('member_verified', 'success');
                log('redirecting...', 'info');
                setTimeout(() => window.location.href = '/dashboard.html', 500);
            } else {
                log('new_member_detected', 'info');
                log('minting_genesis_memory...', 'info');
                await mintGenesisNFT(address);
            }
        }

        async function mintGenesisNFT(address) {
            try {
                const message = `GΛRO Genesis: ${Date.now()}`;
                const encodedMessage = new TextEncoder().encode(message);
                const signature = await web3auth.provider.request({
                    method: "signMessage",
                    params: { message: encodedMessage }
                });

                const pubKey = await web3auth.provider.request({ method: "getAccounts" });

                const res = await fetch('/mint', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        receiverAddress: address,
                        eventId: 'GENESIS_2025',
                        signature: Array.from(new Uint8Array(signature)),
                        publicKey: pubKey[0],
                        message
                    })
                });

                const data = await res.json();

                if (data.success) {
                    log('genesis_memory_created', 'success');
                    log('welcome_to_garo', 'success');
                    setTimeout(() => window.location.href = '/dashboard.html', 1000);
                } else {
                    log('mint_error: ' + data.error, 'error');
                }
            } catch (e) {
                log('mint_failed: ' + e.message, 'error');
            }
        }

        window.addEventListener('load', initWeb3Auth);
    </script>
</body>

</html>