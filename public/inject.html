<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>GŒõRO | Capture Memory</title>
    <link rel="stylesheet" href="/styles.css">
    <meta name="theme-color" content="#08080f">

    <script src="https://cdn.jsdelivr.net/npm/@web3auth/modal@9.6.0/dist/modal.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@web3auth/solana-provider@9.6.0/dist/solanaProvider.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/buffer/6.0.3/buffer.min.js"></script>

    <style>
        .capture-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-xl);
            text-align: center;
        }

        .capture-icon {
            font-size: 5rem;
            margin-bottom: var(--space-lg);
            animation: float 3s ease-in-out infinite;
        }

        .capture-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: var(--space-sm);
        }

        .capture-desc {
            color: var(--text-secondary);
            margin-bottom: var(--space-2xl);
            max-width: 280px;
        }

        .event-badge {
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-full);
            font-family: monospace;
            font-size: 0.875rem;
            color: var(--accent-primary);
            margin-bottom: var(--space-2xl);
        }

        /* Capture Button */
        .capture-btn {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: var(--accent-gradient);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-glow);
            transition: all var(--transition-normal);
            font-size: 3rem;
            color: white;
        }

        .capture-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 60px var(--accent-glow);
        }

        .capture-btn:active,
        .capture-btn.active {
            transform: scale(0.95);
        }

        .capture-hint {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: var(--space-lg);
        }

        /* Progress Ring */
        .progress-ring {
            position: absolute;
            width: 160px;
            height: 160px;
        }

        .progress-ring circle {
            fill: none;
            stroke: rgba(255, 255, 255, 0.3);
            stroke-width: 4;
        }

        .progress-ring .progress {
            stroke: white;
            stroke-linecap: round;
            stroke-dasharray: 440;
            stroke-dashoffset: 440;
            transition: stroke-dashoffset 1.5s linear;
        }

        /* Status */
        .status-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            max-width: 320px;
            text-align: center;
        }

        .status-icon {
            font-size: 4rem;
            margin-bottom: var(--space-md);
        }

        .status-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: var(--space-sm);
        }

        .status-msg {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .status-btn {
            margin-top: var(--space-lg);
            padding: var(--space-md) var(--space-xl);
            background: var(--accent-gradient);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .back-link {
            position: fixed;
            top: var(--space-lg);
            left: var(--space-lg);
            color: var(--text-muted);
            text-decoration: none;
        }
    </style>
</head>

<body>
    <a href="/dashboard.html" class="back-link">‚Üê Back</a>

    <div class="capture-page" id="main">
        <div class="capture-icon">‚ú®</div>
        <h1 class="capture-title">Capture Memory</h1>
        <p class="capture-desc">Hold the button to capture this moment as a digital collectible</p>

        <div class="event-badge" id="eventBadge">GENESIS_2025</div>

        <div style="position: relative;">
            <svg class="progress-ring" viewBox="0 0 160 160">
                <circle cx="80" cy="80" r="70" />
                <circle class="progress" id="progressCircle" cx="80" cy="80" r="70" />
            </svg>
            <button class="capture-btn" id="captureBtn">üì∏</button>
        </div>

        <p class="capture-hint">Hold for 1.5 seconds</p>
    </div>

    <script>
        const CLIENT_ID = "BLVk4nc6lfY2oRnqR7tDjkZn-Kpv8JbgS3lE6iDDWNh5zhIW2WdM3_h6fBu8n92Y0FuHOflV0TwIKc6yPNK0cSI";
        const NETWORK = "sapphire_devnet";
        let web3auth = null;
        let holdTimer = null;
        let isHolding = false;

        // Get event from URL
        const params = new URLSearchParams(location.search);
        const eventId = params.get('event') || 'GENESIS_2025';
        document.getElementById('eventBadge').textContent = eventId;

        async function initWeb3Auth() {
            const Web3AuthModal = window.Modal?.Web3Auth || window.Web3Auth;
            const SolanaProvider = window.SolanaProvider?.SolanaPrivateKeyProvider || window.SolanaPrivateKeyProvider;

            const chainConfig = {
                chainNamespace: "solana",
                chainId: "0x3",
                rpcTarget: "https://api.devnet.solana.com",
                displayName: "Solana Devnet",
                blockExplorer: "https://explorer.solana.com",
                ticker: "SOL",
                tickerName: "Solana",
            };

            const privateKeyProvider = new SolanaProvider({ config: { chainConfig } });

            web3auth = new Web3AuthModal({
                clientId: CLIENT_ID,
                web3AuthNetwork: NETWORK,
                chainConfig,
                privateKeyProvider,
                uiConfig: { mode: "dark", uxMode: "redirect" }
            });

            await web3auth.initModal();
        }

        function startHold() {
            if (isHolding) return;
            isHolding = true;

            const btn = document.getElementById('captureBtn');
            const progress = document.getElementById('progressCircle');

            btn.classList.add('active');
            progress.style.strokeDashoffset = '0';

            holdTimer = setTimeout(() => {
                capture();
            }, 1500);
        }

        function endHold() {
            if (!isHolding) return;
            isHolding = false;

            clearTimeout(holdTimer);

            const btn = document.getElementById('captureBtn');
            const progress = document.getElementById('progressCircle');

            btn.classList.remove('active');
            progress.style.strokeDashoffset = '440';
        }

        async function capture() {
            endHold();
            showStatus('loading', 'Capturing...', 'Connecting to your wallet');

            try {
                if (!web3auth) await initWeb3Auth();

                if (!web3auth.connected) {
                    await web3auth.connect();
                }

                const accounts = await web3auth.provider.request({ method: "getAccounts" });
                const address = accounts[0];

                showStatus('loading', 'Minting...', 'Creating your memory');

                const message = `GŒõRO Capture: ${Date.now()}`;
                const encodedMessage = new TextEncoder().encode(message);
                const signature = await web3auth.provider.request({
                    method: "signMessage",
                    params: { message: encodedMessage }
                });

                const res = await fetch('/mint', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        receiverAddress: address,
                        eventId: eventId,
                        signature: Array.from(new Uint8Array(signature)),
                        publicKey: address,
                        message
                    })
                });

                const data = await res.json();

                if (data.success) {
                    showStatus('success', 'Captured!', 'Memory added to your collection');
                } else {
                    showStatus('error', 'Failed', data.error || 'Something went wrong');
                }

            } catch (e) {
                showStatus('error', 'Error', e.message);
            }
        }

        function showStatus(type, title, msg) {
            const icons = { loading: '‚è≥', success: '‚úÖ', error: '‚ùå' };

            document.getElementById('main').innerHTML = `
                <div class="status-card">
                    <div class="status-icon">${icons[type]}</div>
                    <h2 class="status-title">${title}</h2>
                    <p class="status-msg">${msg}</p>
                    ${type !== 'loading' ? '<a href="/dashboard.html" class="status-btn">View Collection</a>' : ''}
                </div>
            `;
        }

        // Setup hold events
        const btn = document.getElementById('captureBtn');
        btn.addEventListener('mousedown', startHold);
        btn.addEventListener('mouseup', endHold);
        btn.addEventListener('mouseleave', endHold);
        btn.addEventListener('touchstart', e => { e.preventDefault(); startHold(); });
        btn.addEventListener('touchend', endHold);

        initWeb3Auth();
    </script>
</body>

</html>